<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>R.L ENERGIE — STOCK v5K</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    :root{--primary:#00aaff;--primary-dark:#0088cc;--success:#00d46a;--danger:#ff3b5c;--pdf-red:#e63946;--accent:#00ff88;
      --bg-dark:linear-gradient(135deg,#0a0a0a,#151515);--bg-light:linear-gradient(135deg,#eaf6ff,#dbeefe);
      --card-dark:#151515;--card-light:#fff;--text-dark:#eaeef2;--text-light:#2d3436;--muted:#9aa4ad;
      --radius-lg:20px;--shadow-md:0 12px 40px rgba(0,0,0,.45);--transition:all .28s cubic-bezier(.4,0,.2,1);}
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif}
    body{background:var(--bg-light);color:var(--text-light);min-height:100vh;padding:22px 12px;transition:var(--transition);position:relative;overflow-x:hidden;}
    body.dark{background:var(--bg-dark);color:var(--text-dark);}
    body::after{content:"";position:fixed;inset:0;background-image:
      radial-gradient(circle at 10% 20%, rgba(255,255,255,0.02) 0 2px, transparent 3px),
      radial-gradient(circle at 80% 80%, rgba(0,255,136,0.02) 0 2px, transparent 3px);pointer-events:none;z-index:-1;}
    header{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;padding:26px;text-align:center;border-radius:var(--radius-lg);box-shadow:var(--shadow-md);margin-bottom:28px;position:relative;overflow:hidden;}
    .logo-top{position:absolute;top:14px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.85);color:#fff;padding:6px 14px;border-radius:12px;font-weight:900;box-shadow:0 4px 12px rgba(0,0,0,.25);z-index:10;animation:pulse 3s infinite;}
    body.dark .logo-top{background:#fff;color:var(--primary);}
    @keyframes pulse{0%,100%{transform:translateX(-50%) scale(1)}50%{transform:translateX(-50%) scale(1.05)}}
    h1{font-size:2.4rem;font-weight:900;margin-top:26px;}
    .stats-bar{display:flex;gap:14px;justify-content:center;margin-top:14px;flex-wrap:wrap;}
    .stat{background:rgba(255,255,255,.06);padding:8px 14px;border-radius:12px;font-weight:700;}
    .card{background:var(--card-light);border-radius:var(--radius-lg);box-shadow:var(--shadow-md);overflow:hidden;margin:18px auto;max-width:1100px;}
    body.dark .card{background:var(--card-dark);}
    .ch{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;padding:18px 26px;font-weight:800;display:flex;align-items:center;gap:12px;}
    .cb{padding:26px;}
    .g{display:grid;grid-template-columns:1fr 1fr 1fr 110px 160px 180px;gap:14px;align-items:end;}
    @media(max-width:980px){.g{grid-template-columns:1fr 1fr;}}
    @media(max-width:540px){.g{grid-template-columns:1fr;}}
    select,input{width:100%;padding:12px 14px;border-radius:12px;border:2px solid #e6eef8;background:#fff;color:var(--text-light);}
    body.dark select,input{border-color:rgba(255,255,255,0.06);background:transparent;color:inherit;}
    .btn{padding:12px 18px;border-radius:12px;font-weight:800;display:inline-flex;align-items:center;gap:8px;border:none;box-shadow:0 4px 12px rgba(0,0,0,.25);transition:var(--transition);cursor:pointer;}
    .ok{background:var(--success);color:#000;}.new{background:#ff6b35;color:#fff;}.pdf{background:var(--pdf-red);color:#fff;}
    .s{width:100%;padding:14px 16px;border-radius:14px;border:2px solid #e6eef8;background:#fff;color:var(--text-light);margin:18px 0;}
    body.dark .s{border-color:rgba(255,255,255,0.04);background:transparent;}
    table{width:100%;border-collapse:separate;border-spacing:0 12px;margin-top:8px;}
    th{background:var(--primary);color:#fff;padding:12px;border-radius:12px 12px 0 0;font-weight:800;}
    td{background:#fff;padding:12px;text-align:center;border-radius:12px;box-shadow:0 4px 15px rgba(0,0,0,.1);}
    body.dark td{background:rgba(255,255,255,0.02);box-shadow:none;}
    .q{display:flex;gap:10px;justify-content:center;align-items:center;}
    .qb{width:44px;height:44px;border-radius:50%;background:var(--accent);color:#000;border:none;font-size:1.4rem;display:flex;align-items:center;justify-content:center;transition:var(--transition);}
    .qb:hover{transform:scale(1.15) rotate(90deg);background:#00ff88;}
    .qv{font-weight:900;font-size:1.2rem;color:var(--accent);}.qv.out{color:var(--danger);}
    .del-btn{width:40px;height:40px;border-radius:50%;background:var(--danger);color:#fff;display:flex;align-items:center;justify-content:center;border:none;transition:var(--transition);}
    .del-btn:hover{transform:scale(1.12) rotate(10deg);}
    .fab{position:fixed;bottom:24px;right:24px;z-index:9999;display:flex;gap:10px;flex-direction:column;}
    .fab button.small{padding:12px 14px;border-radius:50px;background:var(--primary);color:#fff;border:none;box-shadow:0 4px 12px rgba(0,0,0,.25);font-weight:800;}
    .fab button.small.pdf{background:var(--pdf-red);}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.8);justify-content:center;align-items:flex-start;padding:18px;z-index:10000;overflow:auto;}
    .modal-content{background:var(--card-light);padding:26px;border-radius:18px;width:90%;max-width:760px;box-shadow:var(--shadow-md);}
    body.dark .modal-content{background:var(--card-dark);}
    .close{float:right;font-size:1.8rem;color:#bbb;cursor:pointer;}
    #toast{position:fixed;bottom:18px;right:18px;z-index:11000;pointer-events:none;}
    .toast-msg{background:var(--success);color:#000;padding:12px 18px;border-radius:12px;box-shadow:var(--shadow-md);font-weight:800;display:flex;gap:8px;align-items:center;animation:slide 0.4s ease;}
    @keyframes slide{from{transform:translateY(100px);opacity:0}to{transform:translateY(0);opacity:1}}
    .switch{position:relative;display:inline-block;width:52px;height:28px;}
    .switch input{opacity:0;width:0;height:0;}
    .slider{position:absolute;cursor:pointer;inset:0;background:#ccc;border-radius:20px;transition:.4s;}
    .slider:before{position:absolute;content:"";height:22px;width:22px;left:4px;top:3px;background:#fff;border-radius:50%;transition:.4s;}
    input:checked + .slider{background:var(--primary);}
    input:checked + .slider:before{transform:translateX(24px);}
  </style>
</head>
<body class="light">

  <div id="toast"></div>

  <header>
    <div class="logo-top">&lt; R.L ENERGIE &gt;</div>
    <h1>Inventaire</h1>
    <div class="sub">Stock & Suivi</div>
    <div class="week-moves" id="weekMoves">0 mouvements cette semaine</div>
    <div class="stats-bar">
      <div class="stat">Total: <span id="totalItems">0</span></div>
      <div class="stat">Entrées: <span id="entriesWeek">0</span></div>
      <div class="stat">Sorties: <span id="exitsWeek">0</span></div>
    </div>
  </header>

  <div class="card">
    <div class="ch">Ajouter un produit</div>
    <div class="cb">
      <div class="g">
        <div><label>Catégorie</label><select id="cat" onchange="updateRefSelect()"><option value="">Choisir...</option><option>PANNEAUX</option><option>COFFRET</option><option>MONITORING</option><option>DIVERS PETIT MATÉRIEL</option><option>CÂBLE SOLAIRE</option><option>ONDULEURS</option><option>DISJONCTEUR DIFFÉRENTIEL</option></select></div>
        <div><label>Référence</label><select id="refSelect" onchange="fillNomFromSelect()"><option value="">Sélectionner...</option></select></div>
        <div><label>Nom</label><input id="nom" readonly placeholder="Auto-rempli"></div>
        <div><label>Qté</label><input id="qte" type="number" value="1" min="1"></div>
        <div><button class="btn ok sound-btn" onclick="add()">AJOUTER</button></div>
        <div><button class="btn new sound-btn" onclick="openModal()">Gérer refs</button></div>
      </div>
      <input type="text" class="s" id="search" placeholder="Recherche instantanée..." oninput="show()">
    </div>
  </div>

  <div class="card">
    <div class="ch">Stock — <span id="tot">0</span> produits</div>
    <div class="cb">
      <div style="display:flex;gap:12px;margin-bottom:12px;">
        <select id="catFilter" onchange="show()"><option value="">Toutes catégories</option></select>
        <button class="btn" onclick="clearFilter()">Réinitialiser</button>
      </div>
      <table><thead><tr><th>Réf</th><th>Produit</th><th>Stock</th><th>Catégorie</th><th>Actions</th></tr></thead><tbody id="tab"></tbody></table>
    </div>
  </div>

  <div class="card">
    <div class="ch">Derniers mouvements (10)</div>
    <div class="cb">
      <input type="text" class="s" id="searchSuivi" placeholder="Recherche mouvements..." style="margin-bottom:12px" oninput="updateLast5()">
      <table><thead><tr><th>Date</th><th>Réf</th><th>Produit</th><th>Qté</th><th>Type</th></tr></thead><tbody id="suiviTab"></tbody></table>
      <div id="moreBtn" style="margin-top:12px;text-align:center;"><button class="btn" onclick="openFullSuivi()">Voir plus</button></div>
    </div>
  </div>

  <div class="fab">
    <button class="small sound-btn" onclick="manageExport()" title="CSV"><i class="fas fa-table"></i></button>
    <button class="small pdf sound-btn" onclick="generatePDF()" title="PDF"><i class="fas fa-file-pdf"></i></button>
    <button class="small sound-btn" onclick="openSettings()" title="Paramètres"><i class="fas fa-cog"></i></button>
  </div>

  <!-- MODALS -->
  <div class="modal" id="modal"><div class="modal-content">
    <span class="close" onclick="closeModal()">x</span>
    <h2>Gérer les références</h2>
    <div style="border-bottom:2px solid rgba(255,255,255,0.06);padding-bottom:14px;margin-bottom:16px">
      <h3 style="color:var(--success)">Ajouter une référence</h3>
      <div style="display:grid;gap:10px;">
        <select id="newCat"><option>PANNEAUX</option><option>COFFRET</option><option>MONITORING</option><option>DIVERS PETIT MATÉRIEL</option><option>CÂBLE SOLAIRE</option><option>ONDULEURS</option><option>DISJONCTEUR DIFFÉRENTIEL</option></select>
        <input id="newRef" placeholder="/REF">
        <input id="newNom" placeholder="Nom produit">
      </div>
      <button class="btn ok sound-btn" style="margin-top:10px" onclick="saveNewRef()">AJOUTER</button>
    </div>
    <div>
      <h3 style="color:var(--danger)">Supprimer une référence</h3>
      <select id="delCat" onchange="loadRefsToDelete()"><option value="">Catégorie</option><option>PANNEAUX</option><option>COFFRET</option><option>MONITORING</option><option>DIVERS PETIT MATÉRIEL</option><option>CÂBLE SOLAIRE</option><option>ONDULEURS</option><option>DISJONCTEUR DIFFÉRENTIEL</option></select>
      <select id="delRefSelect"><option value="">Référence</option></select>
      <button class="btn" style="background:var(--danger);color:#fff;margin-top:10px" onclick="deleteRef()">SUPPRIMER</button>
    </div>
  </div></div>

  <div class="modal" id="qtyModal"><div class="modal-content" style="max-width:420px;padding:30px">
    <span class="close" onclick="closeQtyModal()">x</span>
    <h2 id="qtyTitle">Combien ?</h2>
    <p id="qtyName" style="margin:15px 0;font-size:1.1rem;color:var(--primary);font-weight:700;"></p>
    <input type="number" id="qtyInput" min="1" autofocus style="width:160px;padding:12px;border-radius:12px;margin:20px auto;display:block;font-weight:900;">
    <div style="display:flex;gap:12px;justify-content:center;">
      <button class="btn ok" onclick="confirmQty()">OK</button>
      <button class="btn" style="background:#666;color:#fff" onclick="closeQtyModal()">Annuler</button>
    </div>
  </div></div>

  <div class="modal" id="fullSuiviModal"><div class="modal-content" style="max-width:1000px">
    <span class="close" onclick="closeFullSuivi()">x</span>
    <h2>Suivi complet</h2>
    <input type="text" class="s" id="searchFullSuivi" placeholder="Recherche..." oninput="updateFullSuivi()" style="margin-bottom:15px">
    <div style="overflow-x:auto"><table><thead><tr><th>Date</th><th>Réf</th><th>Produit</th><th>Qté</th><th>Type</th></tr></thead><tbody id="fullSuiviTab"></tbody></table></div>
  </div></div>

  <div class="modal" id="settingsModal"><div class="modal-content">
    <span class="close" onclick="closeSettings()">x</span>
    <h2>Paramètres</h2>
    <div style="display:grid;gap:12px;">
      <div style="display:flex;justify-content:space-between;align-items:center;"><span>Mode sombre</span><label class="switch"><input type="checkbox" id="darkModeToggle" onchange="toggleTheme()"><span class="slider"></span></label></div>
      <div style="display:flex;justify-content:space-between;align-items:center;"><span>Sons</span><label class="switch"><input type="checkbox" id="soundToggle" checked onchange="toggleSound()"><span class="slider"></span></label></div>
      <button class="btn" style="background:var(--danger);color:#fff" onclick="resetAll()">Réinitialiser tout</button>
      <button class="btn" style="background:#9c27b0;color:#fff" onclick="restoreBackup()">Restaurer sauvegarde</button>
    </div>
  </div></div>

<script>
let stock = JSON.parse(localStorage.getItem('RLSTOCK')) || {};
let suivi = JSON.parse(localStorage.getItem('RL_SUIVI')) || [];
let BASE = JSON.parse(localStorage.getItem("RL_BASE_REFS")) || {
  PANNEAUX: [
    "/PVQCEL-G9-385KWC→QCells G9 385 Wc",
    "/PVQCEL-G10-540→QCells G10 540 Wc",
    "/PVTRINA400→Trina 400 Wc",
    "/PVTRINA550→Trina Vertex S+ 550 Wc",
    "/PVJA-545→JA Solar 545 Wc",
    "/PVLONGI-550→Longi Hi-MO 6 550 Wc",
    "/PVLONGI-660→Longi Hi-MO X6 660 Wc",
    "/PVVICTRON-440→Victron 440 Wc",
    "/PVDUAL-550→Dualsun Flash 550 Wc",
    "/PVREC-405→REC Alpha Pure 405 Wc",
    "/PVREC-470→REC Alpha Pure-R 470 Wc",
    "/PVJINKO-615→Jinko Tiger Neo 615 Wc",
    "/PVTRINA-425→Trina Vertex S 425 Wc",
    "/PVTRINA-435→Trina Vertex S 435 Wc",
    "/PVJA-550→JA Solar 550 Wc",
    "/PVLONGI-540→Longi Hi-MO 6 540 Wc",
    "/PVREC-410→REC Alpha Pure 410 Wc"
  ],
  COFFRET: [
    "/COF220A→Coffret 2x20A MC4",
    "/COFDC20A→Coffret DC 20A",
    "/COFDC40A→Coffret DC 40A",
    "/COFDC63A→Coffret DC 63A",
    "/COFDC100A→Coffret DC 100A",
    "/COFDC160A→Coffret DC 160A",
    "/COFDC250A→Coffret DC 250A",
    "/COFDC400A→Coffret DC 400A",
    "/COFDC500A→Coffret DC 500A",
    "/COFDC630A→Coffret DC 630A"
  ],
  MONITORING: [
    "/CLE-WINET-S→Clé Wi-Fi SUNGROW",
    "/CLE-WINET-L→Clé Wi-Fi SUNGROW LAN",
    "/CLE-ETH-SG→Ethernet SUNGROW",
    "/CLE-4G-SG→4G SUNGROW",
    "/CLE-WIFI-HUA→Wi-Fi Huawei",
    "/CLE-4G-HUA→4G Huawei",
    "/CLE-WIFI-FRON→Wi-Fi Fronius",
    "/CLE-ETH-FRON→Ethernet Fronius"
  ],
  "DIVERS PETIT MATÉRIEL": [
    "/COLSONGR19→Colson grand 19mm",
    "/COLSONPT12→Colson petit 12mm",
    "/FIX-RALU→Fixation rail alu",
    "/MC4-MALE→Connecteur MC4 mâle",
    "/MC4-FEMALE→Connecteur MC4 femelle",
    "/MC4-OUTIL→Outil sertissage MC4",
    "/VIS-RAIL→Vis fixation rail M8",
    "/ECROU-RAIL→Écrou rail M8",
    "/RONDELLE→Rondelle M8",
    "/FIX-TOIT→Fixation toit tuile"
  ],
  "CÂBLE SOLAIRE": [
    "/R2V4X10→Câble R2V 4x10mm²",
    "/R2V4X16→Câble R2V 4x16mm²",
    "/H1Z2Z2-6→Câble solaire 6mm² rouge/noir",
    "/H1Z2Z2-10→Câble solaire 10mm² rouge/noir",
    "/H1Z2Z2-4→Câble solaire 4mm² rouge/noir",
    "/TERRE-6→Câble terre 6mm² vert/jaune",
    "/TERRE-16→Câble terre 16mm² vert/jaune"
  ],
  ONDULEURS: [
    "/OND3-MO-HUA→Huawei SUN2000 3kW",
    "/OND5-MO-HUA→Huawei SUN2000 5kW",
    "/OND10-MO-HUA→Huawei SUN2000 10kW",
    "/OND20-MO-HUA→Huawei SUN2000 20kW",
    "/OND8-SG→Sungrow SG8.0RT",
    "/OND17-SG→Sungrow SG17RT",
    "/OND33-SG→Sungrow SG33CX",
    "/OND3-ENP→Enphase IQ8M",
    "/OND5-FRON→Fronius Primo 5.0",
    "/OND6-FRON→Fronius Primo 6.0",
    "/OND8-FRON→Fronius Primo 8.2",
    "/OND10-SG→Sungrow SG10RT",
    "/OND50-SG→Sungrow SG50CX"
  ],
  "DISJONCTEUR DIFFÉRENTIEL": [
    "/AGG160A→AGG 160A 4P",
    "/AGG250A→AGG 250A 4P",
    "/PARAF40A→Parafoudre 40kA Type 2",
    "/DJDC1000V→Disjoncteur DC 1000V 32A",
    "/DJDC1000V-63A→Disjoncteur DC 1000V 63A",
    "/DJDC1000V-100A→Disjoncteur DC 1000V 100A",
    "/DJAC-40A→Disjoncteur AC 40A 4P",
    "/DJAC-63A→Disjoncteur AC 63A 4P",
    "/DJAC-100A→Disjoncteur AC 100A 4P"
  ]
};
let soundEnabled = localStorage.getItem('RL_SOUND') !== 'false';
let currentQtyKey = ''; let isAdding = true;

function toast(msg) {
  const t = document.getElementById('toast');
  const d = document.createElement('div');
  d.className = 'toast-msg';
  d.innerHTML = `<i class="fas fa-check-circle"></i> ${msg}`;
  t.appendChild(d);
  setTimeout(() => d.remove(), 3000);
  if (soundEnabled) new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=').play().catch(()=>{});
}
function playSound() { if (soundEnabled) new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=').play().catch(()=>{}); }

function updateRefSelect() {
  const cat = document.getElementById('cat').value;
  const sel = document.getElementById('refSelect');
  sel.innerHTML = '<option value="">Sélectionner...</option>';
  if (cat && BASE[cat]) {
    BASE[cat].forEach(i => {
      const [ref, nom] = i.split('→');
      const opt = document.createElement('option');
      opt.value = ref; opt.textContent = ref;
      sel.appendChild(opt);
    });
  }
  fillNomFromSelect();
}
function fillNomFromSelect() {
  const ref = document.getElementById('refSelect').value;
  const cat = document.getElementById('cat').value;
  if (ref && cat && BASE[cat]) {
    const item = BASE[cat].find(x => x.startsWith(ref));
    if (item) document.getElementById('nom').value = item.split('→')[1];
  }
}

function add() {
  playSound();
  const cat = document.getElementById('cat').value;
  const ref = document.getElementById('refSelect').value;
  const nom = document.getElementById('nom').value;
  const qte = parseInt(document.getElementById('qte').value) || 0;
  if (!cat || !ref || qte <= 0) return toast('Remplis tout !');
  const key = cat + '|' + ref;
  if (!stock[key]) stock[key] = {cat, ref, nom, q:0};
  stock[key].q += qte;
  suivi.push({date:new Date().toLocaleString(), ref, nom, qte, type:'+'});
  saveAll(); show(); updateLast5(); updateStats();
  toast(`+${qte} ${nom}`);
  document.getElementById('qte').value = 1;
}

function openQtyModal(key, add) {
  currentQtyKey = key; isAdding = add;
  document.getElementById('qtyTitle').textContent = add ? 'Ajouter' : 'Retirer';
  document.getElementById('qtyName').textContent = stock[key].nom;
  document.getElementById('qtyModal').style.display = 'flex';
  document.getElementById('qtyInput').focus();
}
function closeQtyModal() { document.getElementById('qtyModal').style.display = 'none'; document.getElementById('qtyInput').value = ''; }
function confirmQty() {
  const q = parseInt(document.getElementById('qtyInput').value);
  if (!q || q <= 0) return toast('Quantité invalide');
  if (!isAdding && stock[currentQtyKey].q < q) return toast('Pas assez en stock');
  if (isAdding) {
    stock[currentQtyKey].q += q;
    suivi.push({date:new Date().toLocaleString(), ref:stock[currentQtyKey].ref, nom:stock[currentQtyKey].nom, qte:q, type:'+'});
    toast(`+${q} ${stock[currentQtyKey].nom}`);
  } else {
    stock[currentQtyKey].q -= q;
    suivi.push({date:new Date().toLocaleString(), ref:stock[currentQtyKey].ref, nom:stock[currentQtyKey].nom, qte:q, type:'-'});
    toast(`-${q} ${stock[currentQtyKey].nom}`);
  }
  if (stock[currentQtyKey].q <= 0) delete stock[currentQtyKey];
  saveAll(); show(); updateLast5(); updateStats();
  closeQtyModal();
}

function deleteFull(key) {
  playSound();
  if (!confirm('Supprimer définitivement cet article ?')) return;
  const item = stock[key];
  suivi.push({date:new Date().toLocaleString(), ref:item.ref, nom:item.nom, qte:item.q, type:'Supprimé'});
  delete stock[key];
  saveAll(); show(); updateLast5(); updateStats();
  toast(`${item.nom} supprimé`);
}

function show() {
  const search = document.getElementById('search').value.toLowerCase();
  const filter = document.getElementById('catFilter').value;
  const tab = document.getElementById('tab'); tab.innerHTML = '';
  let tot = 0;
  Object.keys(stock).forEach(k => {
    const i = stock[k];
    if (filter && i.cat !== filter) return;
    if (search && !i.nom.toLowerCase().includes(search) && !i.ref.toLowerCase().includes(search)) return;
    tot += i.q;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i.ref}</td>
      <td>${i.nom}</td>
      <td><div class="q">
        <button class="qb sound-btn" onclick="openQtyModal('${k}', false)">−</button>
        <span class="qv ${i.q<5?'out':''}">${i.q}</span>
        <button class="qb sound-btn" onclick="openQtyModal('${k}', true)">+</button>
      </div></td>
      <td>${i.cat}</td>
      <td><button class="del-btn sound-btn" onclick="deleteFull('${k}')"><i class="fas fa-trash"></i></button></td>
    `;
    tab.appendChild(tr);
  });
  document.getElementById('tot').textContent = tot;
}

function updateLast5() {
  const search = document.getElementById('searchSuivi').value.toLowerCase();
  const tab = document.getElementById('suiviTab'); tab.innerHTML = '';
  const recent = suivi.slice(-10).reverse().filter(m => !search || m.nom.toLowerCase().includes(search) || m.ref.toLowerCase().includes(search));
  recent.forEach(m => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${m.date.split(',')[1]||m.date}</td><td>${m.ref}</td><td>${m.nom}</td><td>${m.type}${m.qte}</td><td>${m.type==='+'?'Entrée':'Sortie'}</td>`;
    tab.appendChild(tr);
  });
}

function openFullSuivi() {
  updateFullSuivi();
  document.getElementById('fullSuiviModal').style.display = 'flex';
}
function updateFullSuivi() {
  const search = document.getElementById('searchFullSuivi').value.toLowerCase();
  const tab = document.getElementById('fullSuiviTab'); tab.innerHTML = '';
  suivi.slice().reverse().filter(m => !search || m.nom.toLowerCase().includes(search) || m.ref.toLowerCase().includes(search)).forEach(m => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${m.date}</td><td>${m.ref}</td><td>${m.nom}</td><td>${m.type}${m.qte}</td><td>${m.type==='+'?'Entrée':'Sortie'}</td>`;
    tab.appendChild(tr);
  });
}
function closeFullSuivi() { document.getElementById('fullSuiviModal').style.display = 'none'; }

function updateStats() {
  const now = new Date();
  const weekStart = new Date(now.setDate(now.getDate() - now.getDay()));
  weekStart.setHours(0,0,0,0);
  const weekMoves = suivi.filter(m => new Date(m.date) >= weekStart);
  const entries = weekMoves.filter(m => m.type === '+').reduce((a,b)=>a+b.qte,0);
  const exits = weekMoves.filter(m => m.type === '-').reduce((a,b)=>a+b.qte,0);
  document.getElementById('weekMoves').textContent = `${weekMoves.length} mouvements cette semaine`;
  document.getElementById('totalItems').textContent = Object.values(stock).reduce((a,b)=>a+b.q,0);
  document.getElementById('entriesWeek').textContent = entries;
  document.getElementById('exitsWeek').textContent = exits;
}

function generatePDF() {
  playSound();
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF('l','mm','a4');
  doc.setFontSize(22); doc.text('R.L ENERGIE - STOCK', 148, 20, null, null, 'center');
  doc.setFontSize(12); doc.text(`Généré le ${new Date().toLocaleString()}`, 148, 28, null, null, 'center');
  const data = Object.keys(stock).map(k => [stock[k].ref, stock[k].nom, stock[k].q, stock[k].cat]);
  doc.autoTable({head: [['RÉF','PRODUIT','QTÉ','CATÉGORIE']], body: data, startY: 38});
  doc.save('RL_STOCK.pdf');
  toast('PDF généré !');
}

function manageExport() {
  playSound();
  const data = [['RÉF','PRODUIT','QTÉ','CATÉGORIE'], ...Object.keys(stock).map(k => [stock[k].ref, stock[k].nom, stock[k].q, stock[k].cat])];
  const csv = data.map(r => r.join(';')).join('\n');
  const blob = new Blob(['\uFEFF'+csv], {type:'text/csv'});
  const a = document.createElement('a'); a.href = URL.createObjectURL(blob);
  a.download = 'RL_STOCK_'+new Date().toISOString().slice(0,10)+'.csv'; a.click();
  toast('CSV exporté !');
}

function saveAll() {
  localStorage.setItem('RLSTOCK', JSON.stringify(stock));
  localStorage.setItem('RL_SUIVI', JSON.stringify(suivi));
  localStorage.setItem('RL_BASE_REFS', JSON.stringify(BASE));
  localStorage.setItem('RL_BACKUP_AUTO', JSON.stringify({stock:{...stock}, suivi:[...suivi], BASE:{...BASE}}));
}

function restoreBackup() {
  const b = localStorage.getItem('RL_BACKUP_AUTO');
  if (!b) return toast('Aucune sauvegarde');
  if (confirm('Restaurer la sauvegarde automatique ?')) {
    const d = JSON.parse(b);
    stock = d.stock; suivi = d.suivi; BASE = d.BASE;
    saveAll(); location.reload();
  }
}

function resetAll() {
  if (confirm('TOUT EFFACER DÉFINITIVEMENT ?')) {
    localStorage.clear();
    location.reload();
  }
}

function toggleTheme() {
  const on = document.getElementById('darkModeToggle').checked;
  document.body.classList.toggle('dark', on);
  localStorage.setItem('RL_DARK', on);
}
function toggleSound() {
  soundEnabled = document.getElementById('soundToggle').checked;
  localStorage.setItem('RL_SOUND', soundEnabled);
}

function populateCatFilter() {
  const sel = document.getElementById('catFilter');
  sel.innerHTML = '<option value="">Toutes catégories</option>';
  Object.keys(BASE).forEach(c => {
    const opt = document.createElement('option');
    opt.value = c; opt.textContent = c;
    sel.appendChild(opt);
  });
}
function clearFilter() { document.getElementById('catFilter').value = ''; show(); }

function saveNewRef() {
  playSound();
  const cat = document.getElementById('newCat').value;
  const ref = document.getElementById('newRef').value.trim();
  const nom = document.getElementById('newNom').value.trim();
  if (!ref || !nom) return toast('Remplis tout');
  if (!BASE[cat]) BASE[cat] = [];
  if (BASE[cat].some(x => x.startsWith(ref))) return toast('Référence existe déjà');
  BASE[cat].push(ref + '→' + nom);
  saveAll(); updateRefSelect(); toast('Référence ajoutée !');
  document.getElementById('newRef').value = ''; document.getElementById('newNom').value = '';
}
function loadRefsToDelete() {
  const cat = document.getElementById('delCat').value;
  const sel = document.getElementById('delRefSelect');
  sel.innerHTML = '<option value="">Choisir...</option>';
  if (cat && BASE[cat]) {
    BASE[cat].forEach(x => {
      const opt = document.createElement('option');
      opt.value = x.split('→')[0];
      opt.textContent = x;
      sel.appendChild(opt);
    });
  }
}
function deleteRef() {
  playSound();
  const cat = document.getElementById('delCat').value;
  const ref = document.getElementById('delRefSelect').value;
  if (!cat || !ref) return toast('Sélectionne une référence');
  BASE[cat] = BASE[cat].filter(x => !x.startsWith(ref));
  if (BASE[cat].length === 0) delete BASE[cat];
  saveAll(); updateRefSelect(); loadRefsToDelete(); toast('Référence supprimée');
}

function closeModal() { document.getElementById('modal').style.display = 'none'; }
function openModal() { document.getElementById('modal').style.display = 'flex'; loadRefsToDelete(); }
function openSettings() { document.getElementById('settingsModal').style.display = 'flex'; }
function closeSettings() { document.getElementById('settingsModal').style.display = 'none'; }

window.onload = () => {
  const dark = localStorage.getItem('RL_DARK') === 'true';
  document.body.classList.toggle('dark', dark);
  document.getElementById('darkModeToggle').checked = dark;
  soundEnabled = localStorage.getItem('RL_SOUND') !== 'false';
  document.getElementById('soundToggle').checked = soundEnabled;

  updateRefSelect();
  populateCatFilter();
  show();
  updateLast5();
  updateStats();
  saveAll();
  toast('R.L ENERGIE v5K 100% PRÊT !');
};
</script>
</body>
</html>