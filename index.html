<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>R.L ENERGIE ‚Äî STOCK (offline ready)</title>

  <!-- NOTE: For true offline/APK behaviour, replace the CDN script tags with local copies
       and include them in your APK (assets/www). See comments near the script imports. -->

  <!-- Styles (concise, responsive) -->
  <style>
    :root{
      --primary:#00aaff; --success:#00d46a; --danger:#ff3b5c; --accent:#00ff88;
      --card:#ffffff; --card-dark:#121212; --radius:14px; --muted:#8c98a4;
    }
    *{box-sizing:border-box}
    body{font-family:Inter, system-ui, Arial, sans-serif;margin:14px;background:linear-gradient(180deg,#eaf6ff,#dbeefe);color:#1c2b33}
    header{background:linear-gradient(135deg,var(--primary),#0088cc);color:#fff;padding:18px;border-radius:18px;text-align:center;margin-bottom:12px}
    .logo{font-weight:900;display:inline-block;padding:6px 10px;border-radius:10px;background:rgba(255,255,255,0.08)}
    .container{max-width:1100px;margin:0 auto}
    .card{background:var(--card);border-radius:var(--radius);padding:14px;margin-bottom:12px;box-shadow:0 8px 30px rgba(0,0,0,0.06)}
    .grid{display:grid;grid-template-columns:repeat(3,1fr) 120px 120px;gap:10px;align-items:end}
    @media(max-width:900px){.grid{grid-template-columns:1fr 1fr 1fr}}
    @media(max-width:560px){.grid{grid-template-columns:1fr}}
    label{font-weight:700;margin-bottom:6px;display:block;color:#234}
    input,select,button{padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.06);font-size:15px}
    .s{width:100%;padding:10px;border-radius:12px;margin-top:12px}
    table{width:100%;border-collapse:separate;border-spacing:0 10px;margin-top:10px}
    th{background:var(--primary);color:#fff;padding:10px;border-radius:10px 10px 0 0;text-align:left}
    td{background:#f8fbff;padding:10px;border-radius:10px;text-align:left;vertical-align:middle}
    .q{display:flex;align-items:center;gap:10px;justify-content:center}
    .qb{width:40px;height:40px;border-radius:50%;border:none;cursor:pointer}
    .del-btn{background:var(--danger);color:#fff;border:none;border-radius:8px;padding:8px 10px;cursor:pointer}
    .btn{cursor:pointer;border:none;padding:10px 14px;border-radius:10px;font-weight:800}
    .ok{background:var(--success);color:#000}
    .pdf{background:#e63946;color:#fff}
    .ghost{background:transparent;border:1px solid rgba(0,0,0,.06)}
    .fab{position:fixed;right:18px;bottom:18px;display:flex;flex-direction:column;gap:8px}
    .modal{display:none;position:fixed;inset:0;background:rgba(0,0,0,.6);align-items:flex-start;justify-content:center;padding:20px;z-index:999}
    .modal-content{background:var(--card);padding:16px;border-radius:12px;width:100%;max-width:820px}
    .toast{position:fixed;right:18px;bottom:112px;z-index:10000}
    .toast .msg{background:var(--success);padding:10px;border-radius:10px;color:#000;font-weight:700}
    small.muted{color:var(--muted)}
  </style>
</head>
<body>

  <header>
    <div class="logo">&lt; R.L ENERGIE &gt;</div>
    <h1 style="margin:6px 0 0">Inventaire ‚Äî Stock local</h1>
    <div style="margin-top:6px;opacity:.95">Fonctionne offline ‚Äî pr√©pare pour APK</div>
  </header>

  <div class="container">

    <!-- ADD -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Ajouter un produit</strong>
        <small class="muted">LocalStorage ‚Ä¢ Offline</small>
      </div>

      <div style="margin-top:10px" class="grid">
        <div>
          <label>Cat√©gorie</label>
          <select id="cat" onchange="updateRefSelect()"><option value="">Choisir...</option></select>
        </div>
        <div>
          <label>R√©f√©rence</label>
          <select id="refSelect" onchange="fillNomFromSelect()"><option value="">S√©lectionner...</option></select>
        </div>
        <div>
          <label>Nom</label>
          <input id="nom" readonly placeholder="Auto-rempli">
        </div>
        <div>
          <label>Qt√©</label>
          <input id="qte" type="number" value="1" min="1">
        </div>
        <div style="display:flex;align-items:center;justify-content:center">
          <button class="btn ok" onclick="add()">AJOUTER</button>
        </div>
      </div>

      <input id="search" class="s" placeholder="Recherche instantan√©e..." oninput="show()">
    </div>

    <!-- STOCK -->
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <strong>Stock ‚Äî <span id="tot">0</span> produits</strong>
        <div>
          <select id="catFilter" onchange="show()"><option value="">Toutes cat√©gories</option></select>
          <button class="btn ghost" onclick="clearFilter()">R√©initialiser</button>
        </div>
      </div>

      <table>
        <thead><tr><th>R√©f</th><th>Produit</th><th style="width:170px">Stock</th><th>Cat√©gorie</th><th style="width:120px">Actions</th></tr></thead>
        <tbody id="tab"></tbody>
      </table>
    </div>

    <!-- SUIVI -->
    <div class="card">
      <strong>Derniers mouvements (10)</strong>
      <input id="searchSuivi" class="s" placeholder="Recherche mouvements..." oninput="updateLast5()">
      <table><thead><tr><th>Date</th><th>R√©f</th><th>Produit</th><th>Qt√©</th><th>Type</th></tr></thead><tbody id="suiviTab"></tbody></table>
      <div style="text-align:center;margin-top:10px"><button class="btn ghost" onclick="openFullSuivi()">Voir tout</button></div>
    </div>

    <!-- PARAMS / EXPORT -->
    <div class="card" style="display:flex;gap:10px;flex-wrap:wrap;align-items:center;justify-content:space-between">
      <div style="display:flex;gap:8px;align-items:center">
        <label style="margin-right:6px">Mode sombre</label>
        <input id="darkModeToggle" type="checkbox" onchange="toggleTheme()">
        <small class="muted" style="margin-left:8px">‚Ä¢ Sons configurable</small>
      </div>

      <div style="display:flex;gap:8px;flex-wrap:wrap">
        <button class="btn ghost" onclick="exportCSV()">Export CSV</button>
        <button class="btn pdf" onclick="generatePDF()">Export PDF</button>
        <button class="btn ok" onclick="exportXLSX()">Export XLSX</button>
        <button class="btn ghost" onclick="exportBackupJSON()">Backup JSON</button>
        <button class="btn" style="background:var(--danger);color:#fff" onclick="resetAll()">R√©initialiser</button>
      </div>
    </div>

  </div>

  <!-- FAB -->
  <div class="fab" aria-hidden>
    <button class="btn" onclick="openModal()">G√©rer cat√©gories</button>
  </div>

  <!-- MODALS -->
  <div class="modal" id="modal">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>G√©rer cat√©gories & r√©f√©rences</h3>
        <button class="btn ghost" onclick="closeModal()">Fermer</button>
      </div>

      <div style="margin-top:12px;border-top:1px solid #eee;padding-top:12px;display:grid;gap:10px">
        <div>
          <strong>Ajouter cat√©gorie</strong>
          <div style="display:flex;gap:8px;margin-top:8px">
            <input id="newCategoryInput" placeholder="Nom cat√©gorie (ex: RACKS)">
            <button class="btn ok" onclick="addCategory()">Cr√©er</button>
          </div>
        </div>

        <div>
          <strong>Ajouter r√©f√©rence</strong>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:8px">
            <select id="newCat"></select>
            <input id="newRef" placeholder="/REF001">
            <input id="newNom" placeholder="Nom produit">
            <div style="text-align:right"><button class="btn ok" onclick="saveNewRef()">Ajouter r√©f√©rence</button></div>
          </div>
        </div>

        <div>
          <strong>Supprimer r√©f√©rence / cat√©gorie</strong>
          <div style="display:grid;gap:8px;margin-top:8px">
            <select id="delCat" onchange="loadRefsToDelete()"></select>
            <select id="delRefSelect"></select>
            <div style="display:flex;gap:8px">
              <button class="btn" style="background:var(--danger);color:#fff" onclick="deleteRef()">Supprimer r√©f√©rence</button>
              <button class="btn" style="background:var(--danger);color:#fff" onclick="deleteCategory()">Supprimer cat√©gorie</button>
            </div>
            <small class="muted">Supprimer une cat√©gorie supprime aussi ses r√©f√©rences et articles stock√©s.</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Full suivi modal -->
  <div class="modal" id="fullSuiviModal">
    <div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <h3>Suivi complet</h3>
        <button class="btn ghost" onclick="closeFullSuivi()">Fermer</button>
      </div>
      <input id="searchFullSuivi" class="s" placeholder="Recherche..." oninput="updateFullSuivi()" />
      <div style="overflow:auto;max-height:60vh;margin-top:10px">
        <table style="width:100%"><thead><tr><th>Date</th><th>R√©f</th><th>Produit</th><th>Qt√©</th><th>Type</th></tr></thead><tbody id="fullSuiviTab"></tbody></table>
      </div>
    </div>
  </div>

  <div id="toast" class="toast"></div>

  <!-- LIBRARIES (CDN fallback; for offline replace with local files inside APK) -->
  <!-- Replace these <script> with local file paths when packaging for offline APK: e.g. /assets/js/jspdf.umd.min.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script>
  /* =========================
     DATA
     ========================= */
  let BASE = JSON.parse(localStorage.getItem('RL_BASE_REFS')) || {
    PANNEAUX: [
      "/PVQCEL-G9-385KWC‚ÜíQCells G9 385 Wc",
      "/PVTRINA550‚ÜíTrina Vertex S+ 550 Wc",
      "/PVJA-550‚ÜíJA Solar 550 Wc"
    ],
    COFFRET: ["/COF220A‚ÜíCoffret 2x20A MC4"],
    MONITORING: ["/CLE-WINET-S‚ÜíCl√© Wi-Fi SUNGROW"],
    "DIVERS PETIT MAT√âRIEL": ["/COLSONGR19‚ÜíColson grand 19mm"],
    "C√ÇBLE SOLAIRE":[ "/R2V4X10‚ÜíC√¢ble R2V 4x10mm¬≤" ],
    ONDULEURS:[ "/OND10-MO-HUA‚ÜíHuawei 10 kW" ]
  };

  let stock = JSON.parse(localStorage.getItem('RLSTOCK')) || {};
  let suivi = JSON.parse(localStorage.getItem('RL_SUIVI')) || [];
  let soundEnabled = localStorage.getItem('RL_SOUND') !== 'false';

  /* ====== helpers ====== */
  function toast(msg, t=2200){
    const box=document.getElementById('toast');
    const d=document.createElement('div'); d.className='msg'; d.style.marginTop='6px';
    d.textContent = msg; box.appendChild(d); setTimeout(()=>d.remove(), t);
  }
  function saveAll(){
    localStorage.setItem('RL_BASE_REFS', JSON.stringify(BASE));
    localStorage.setItem('RLSTOCK', JSON.stringify(stock));
    localStorage.setItem('RL_SUIVI', JSON.stringify(suivi));
  }

  /* ====== categories/ref UI ====== */
  function populateAllCats(){
    const ids = ['cat','catFilter','newCat','delCat','delRefCat'];
    ids.forEach(id=>{
      const el = document.getElementById(id);
      if(!el) return;
      const prev = el.value;
      el.innerHTML = (id==='catFilter' ? '<option value="">Toutes cat√©gories</option>' : '<option value="">Choisir...</option>');
      Object.keys(BASE).sort().forEach(k=>{
        const o=document.createElement('option'); o.value=k; o.textContent=k;
        if(k===prev) o.selected=true;
        el.appendChild(o);
      });
    });
    // sync delete cat selector
    const delCat = document.getElementById('delCat');
    if(delCat) loadRefsToDelete();
  }

  function updateRefSelect(){
    const c = document.getElementById('cat').value;
    const sel = document.getElementById('refSelect'); sel.innerHTML='<option value="">S√©lectionner...</option>';
    if(!c || !BASE[c]) return fillNomFromSelect();
    BASE[c].forEach(it=>{
      const [r,n] = it.split('‚Üí');
      const o=document.createElement('option'); o.value=r; o.textContent = r + ' ‚Äî ' + (n||'');
      sel.appendChild(o);
    });
    fillNomFromSelect();
  }
  function fillNomFromSelect(){
    const c=document.getElementById('cat').value;
    const r=document.getElementById('refSelect').value;
    document.getElementById('nom').value='';
    if(!c || !r) return;
    const item = (BASE[c]||[]).find(x=>x.startsWith(r));
    if(item) document.getElementById('nom').value = item.split('‚Üí')[1]||'';
  }

  /* ===== category/ref management ===== */
  function addCategory(){
    const nm=(document.getElementById('newCategoryInput').value||'').trim();
    if(!nm) return toast('Nom requis');
    if(BASE[nm]) return toast('Existe d√©j√†');
    BASE[nm]=[];
    saveAll(); populateAllCats(); toast('Cat√©gorie cr√©√©e');
    document.getElementById('newCategoryInput').value='';
  }
  function deleteCategory(){
    const cat = document.getElementById('delCat').value;
    if(!cat) return toast('Choisis une cat√©gorie');
    if(!confirm(`Supprimer la cat√©gorie "${cat}" et toutes ses r√©f√©rences ?`)) return;
    // remove associated stock items
    (BASE[cat]||[]).forEach(entry=>{
      const ref = entry.split('‚Üí')[0];
      // stock keys are stored as cat|ref
      const key = Object.keys(stock).find(k=>k.endsWith('|'+ref) || k === cat + '|' + ref);
      if(key){
        suivi.push({date:new Date().toLocaleString(), ref, nom:stock[key].nom, qte:-stock[key].q, type:'Suppression'});
        delete stock[key];
      }
    });
    delete BASE[cat];
    saveAll(); populateAllCats(); show(); updateLast5(); updateStats();
    toast('Cat√©gorie supprim√©e');
  }

  function saveNewRef(){
    const cat = document.getElementById('newCat').value;
    const ref = (document.getElementById('newRef').value||'').trim();
    const nom = (document.getElementById('newNom').value||'').trim();
    if(!cat || !ref || !nom) return toast('Remplis tout');
    if(!BASE[cat]) BASE[cat]=[];
    if(BASE[cat].some(x=>x.startsWith(ref))) return toast('R√©f existe');
    BASE[cat].push(ref+'‚Üí'+nom);
    saveAll(); populateAllCats(); updateRefSelect(); toast('R√©f√©rence ajout√©e');
    document.getElementById('newRef').value=''; document.getElementById('newNom').value='';
  }

  function loadRefsToDelete(){
    const cat = document.getElementById('delCat').value || document.getElementById('delRefCat')?.value;
    const sel = document.getElementById('delRefSelect'); if(!sel) return;
    sel.innerHTML = '<option value="">R√©f√©rence √† supprimer</option>';
    if(!cat || !BASE[cat]) return;
    BASE[cat].forEach(x=>{
      const ref = x.split('‚Üí')[0];
      const o = document.createElement('option'); o.value = ref; o.textContent = x;
      sel.appendChild(o);
    });
  }
  function deleteRef(){
    const cat = document.getElementById('delCat').value;
    const ref = document.getElementById('delRefSelect').value;
    if(!cat || !ref) return toast('Choisis cat√©gorie + r√©f');
    if(!confirm('Supprimer la r√©f√©rence s√©lectionn√©e ?')) return;
    BASE[cat] = BASE[cat].filter(x=>!x.startsWith(ref));
    if(BASE[cat].length===0) delete BASE[cat];
    // remove stock entries for this ref
    const keys = Object.keys(stock).filter(k=>k.endsWith('|'+ref) || k===cat+'|'+ref);
    keys.forEach(k=>{
      suivi.push({date:new Date().toLocaleString(), ref, nom:stock[k].n, qte:-stock[k].q, type:'Suppression'});
      delete stock[k];
    });
    saveAll(); populateAllCats(); updateRefSelect(); show(); updateLast5();
    toast('R√©f√©rence supprim√©e');
  }

  /* ===== add product, qty modal, delete item ===== */
  function add(){
    const cat = document.getElementById('cat').value;
    const ref = document.getElementById('refSelect').value;
    const nom = document.getElementById('nom').value || ref;
    const qte = parseInt(document.getElementById('qte').value) || 0;
    if(!cat || !ref || qte <= 0) return toast('Cat√©gorie + r√©f + quantit√© requises');
    const key = cat + '|' + ref;
    if(!stock[key]) stock[key] = {n:nom,q:0,c:cat};
    stock[key].q += qte;
    suivi.push({date:new Date().toLocaleString(), ref, nom, qte, type:'Entr√©e'});
    saveAll(); show(); updateLast5(); updateStats();
    document.getElementById('qte').value = 1;
    toast('Ajout√©');
  }

  let pendingRef=null;
  function openQtyModalFor(key){
    pendingRef = key;
    const qty = stock[key] ? stock[key].q : 0;
    document.getElementById('qtyTitle').textContent='Modifier quantit√©';
    document.getElementById('qtyName').textContent = stock[key] ? stock[key].n : key;
    document.getElementById('qtyInput').value = qty;
    document.getElementById('qtyModal').style.display='flex';
  }
  function confirmQty(){
    const v = parseInt(document.getElementById('qtyInput').value);
    if(isNaN(v) || v<0) return toast('Quantit√© invalide');
    if(!pendingRef){ closeQtyModal(); return; }
    const prev = stock[pendingRef] ? stock[pendingRef].q : 0;
    const diff = v - prev;
    if(!stock[pendingRef]) stock[pendingRef] = {n:pendingRef,q:0,c:'UNCAT'};
    stock[pendingRef].q = v;
    if(diff !== 0){
      suivi.push({date:new Date().toLocaleString(), ref:stock[pendingRef].ref || pendingRef, nom:stock[pendingRef].n, qte:diff, type: diff>0? 'Entr√©e':'Sortie'});
    }
    if(stock[pendingRef].q <= 0) delete stock[pendingRef];
    saveAll(); show(); updateLast5(); updateStats(); closeQtyModal(); toast('Quantit√© mise √† jour');
  }
  function closeQtyModal(){ document.getElementById('qtyModal').style.display='none'; pendingRef=null; }

  function deleteItem(key){
    if(!stock[key]) return;
    if(!confirm('Supprimer cet article ?')) return;
    suivi.push({date:new Date().toLocaleString(), ref:stock[key].n, nom:stock[key].n, qte:-stock[key].q, type:'Suppression'});
    delete stock[key];
    saveAll(); show(); updateLast5(); updateStats();
    toast('Article supprim√©');
  }

  /* ===== show stock & suivi ===== */
  function show(){
    const q = (document.getElementById('search').value||'').toLowerCase();
    const filt = document.getElementById('catFilter').value;
    const tab=document.getElementById('tab'); tab.innerHTML='';
    let totalCount=0;
    Object.keys(stock).forEach(k=>{
      const it = stock[k];
      if(filt && it.c !== filt) return;
      if(q && !(k.toLowerCase().includes(q) || (it.n && it.n.toLowerCase().includes(q)))) return;
      totalCount += it.q;
      const tr=document.createElement('tr');
      tr.innerHTML = `<td style="font-family:monospace">${k.split('|')[1]||k}</td>
                      <td>${it.n}</td>
                      <td style="text-align:center"><div class="q">
                        <button class="qb" onclick="openQtyModalFor('${k}')">‚úé</button>
                        <span class="qv ${it.q<1?'out':''}">${it.q}</span>
                      </div></td>
                      <td>${it.c}</td>
                      <td style="text-align:center"><button class="del-btn" onclick="deleteItem('${k}')">üóë</button></td>`;
      tab.appendChild(tr);
    });
    document.getElementById('tot').textContent = totalCount;
  }

  function updateLast5(){
    const q=(document.getElementById('searchSuivi').value||'').toLowerCase();
    const arr = suivi.slice(-10).reverse();
    const tab=document.getElementById('suiviTab'); tab.innerHTML='';
    arr.forEach(e=>{
      if(q && !(e.ref.toLowerCase().includes(q) || (e.nom && e.nom.toLowerCase().includes(q)))) return;
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${e.date}</td><td>${e.ref}</td><td>${e.nom}</td><td>${e.qte>0?'+':''}${e.qte}</td><td>${e.type}</td>`;
      tab.appendChild(tr);
    });
  }

  function updateFullSuivi(){
    const q=(document.getElementById('searchFullSuivi').value||'').toLowerCase();
    const tab=document.getElementById('fullSuiviTab'); tab.innerHTML='';
    suivi.slice().reverse().forEach(e=>{
      if(q && !(e.ref.toLowerCase().includes(q) || (e.nom && e.nom.toLowerCase().includes(q)))) return;
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${e.date}</td><td>${e.ref}</td><td>${e.nom}</td><td>${e.qte>0?'+':''}${e.qte}</td><td>${e.type}</td>`;
      tab.appendChild(tr);
    });
  }

  /* ===== exports ===== */
  function exportCSV(){
    const rows = [['R√©f√©rence','Produit','Qt√©','Cat√©gorie']];
    Object.keys(stock).forEach(k => rows.push([k.split('|')[1]||k, stock[k].n, stock[k].q, stock[k].c]));
    const csv = rows.map(r => r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(';')).join('\n');
    const blob = new Blob(['\uFEFF'+csv], {type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='RL_STOCK_'+new Date().toISOString().slice(0,10)+'.csv'; a.click();
    toast('CSV export√©');
  }

  function generatePDF(){
    try{
      const { jsPDF } = window.jspdf || {};
      if(!jsPDF) throw 'jsPDF missing';
      const doc = new jsPDF('p','mm','a4');
      doc.setFontSize(16); doc.text('R.L ENERGIE ‚Äî STOCK', 105, 14, null, null, 'center');
      const rows = Object.keys(stock).map(k => [k.split('|')[1]||k, stock[k].n, String(stock[k].q), stock[k].c]);
      doc.autoTable({head:[['R√©f','Produit','Qt√©','Cat√©gorie']], body: rows, startY:22, styles:{fontSize:9}});
      doc.save('RL_STOCK_'+new Date().toISOString().slice(0,19).replace(/:/g,'-')+'.pdf');
      toast('PDF g√©n√©r√©');
    }catch(err){
      toast('Erreur PDF (v√©rifie jsPDF local ou CDN)');
      console.error(err);
    }
  }

  function exportXLSX(){
    try{
      if(!window.XLSX) throw 'SheetJS missing';
      const rows = Object.keys(stock).map(k => ({R√©f√©rence:(k.split('|')[1]||k), Produit:stock[k].n, Quantit√©:stock[k].q, Cat√©gorie:stock[k].c}));
      const ws = XLSX.utils.json_to_sheet(rows);
      const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,'Stock');
      XLSX.writeFile(wb,'RL_STOCK_'+new Date().toISOString().slice(0,10)+'.xlsx');
      toast('XLSX export√©');
    }catch(e){
      toast('Erreur XLSX (v√©rifie SheetJS local ou CDN)');
      console.error(e);
    }
  }

  function exportBackupJSON(){
    const payload={stock,suivi,BASE,exportedAt:new Date().toISOString()};
    const blob = new Blob([JSON.stringify(payload,null,2)], {type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='RL_BACKUP_'+new Date().toISOString().slice(0,19).replace(/:/g,'-')+'.json'; a.click();
    toast('Backup JSON cr√©√©');
  }

  /* ===== misc ===== */
  function resetAll(){
    if(!confirm('Effacer tout ?')) return;
    localStorage.removeItem('RLSTOCK'); localStorage.removeItem('RL_SUIVI'); localStorage.removeItem('RL_BASE_REFS');
    stock={}; suivi=[]; BASE={}; populateAllCats(); show(); updateLast5(); updateStats();
    toast('Donn√©es r√©initialis√©es');
  }

  function toggleTheme(){
    document.body.classList.toggle('dark', document.getElementById('darkModeToggle').checked);
    localStorage.setItem('RL_DARK', document.getElementById('darkModeToggle').checked ? 'true' : 'false');
  }

  function openModal(){ populateAllCats(); document.getElementById('modal').style.display='flex'; }
  function closeModal(){ document.getElementById('modal').style.display='none'; }
  function openFullSuivi(){ updateFullSuivi(); document.getElementById('fullSuiviModal').style.display='flex'; }
  function closeFullSuivi(){ document.getElementById('fullSuiviModal').style.display='none'; }
  function clearFilter(){ document.getElementById('catFilter').value=''; show(); }

  /* ===== init ===== */
  (function init(){
    populateAllCats(); updateRefSelect(); show(); updateLast5(); updateStats();
    // dark mode
    if(localStorage.getItem('RL_DARK')==='true'){ document.getElementById('darkModeToggle').checked=true; document.body.classList.add('dark'); }
    saveAll();
    toast('R.L ENERGIE ‚Äî pr√™t (offline-ready).');
  })();

  // qty modal markup injection (keeps code tidy)
  (function injectQtyModal(){
    const div = document.createElement('div');
    div.className='modal'; div.id='qtyModal';
    div.innerHTML = `<div class="modal-content">
      <div style="display:flex;justify-content:space-between;align-items:center"><h3 id="qtyTitle">Modifier quantit√©</h3><button class="btn ghost" onclick="closeQtyModal()">Fermer</button></div>
      <p id="qtyName" style="font-weight:800;margin-top:8px"></p>
      <input id="qtyInput" type="number" min="0" style="width:140px;padding:8px;border-radius:8px;border:1px solid #ddd;margin-top:8px" />
      <div style="margin-top:12px;display:flex;gap:8px"><button class="btn ok" onclick="confirmQty()">OK</button><button class="btn ghost" onclick="closeQtyModal()">Annuler</button></div>
    </div>`;
    document.body.appendChild(div);
  })();

  // small keyboard shortcuts (optional)
  window.addEventListener('keydown', e=>{
    if((e.ctrlKey||e.metaKey) && (e.key==='s' || e.key==='S')){ e.preventDefault(); exportCSV(); }
  });

  // prevent accidental pull-to-refresh on tablets
  document.addEventListener('touchmove', e=>{}, {passive:true});
  </script>

</body>
</html>

    
   

