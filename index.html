<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>R.L ENERGIE — STOCK PRO v7 ULTIME</title>

  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

  <!-- Firebase compat SDK (pratique pour intégration simple) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

  <style>
    :root{
      --primary:#00aaff;--primary-dark:#0088cc;--success:#00d46a;--danger:#ff3b5c;--pdf-red:#e63946;--excel-green:#1e7e34;--sync-purple:#9b59b6;--bg-dark:linear-gradient(135deg,#0a0a0a,#151515);--bg-light:linear-gradient(135deg,#eaf6ff,#dbeefe);--card-dark:#151515;--card-light:#ffffff;--text-dark:#eaeef2;--text-light:#2d3436;--radius-lg:20px;--shadow-md:0 12px 40px rgba(0,0,0,.45);--transition:all .28s cubic-bezier(.4,0,.2,1);
    }
    *{margin:0;padding:0;box-sizing:border-box;font-family:'Inter',sans-serif;}
    body{background:var(--bg-light);color:var(--text-light);min-height:100vh;padding:22px 12px;transition:var(--transition);overflow-x:hidden;}
    body.dark{background:var(--bg-dark);color:var(--text-dark);}
    header{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;padding:26px;text-align:center;border-radius:var(--radius-lg);box-shadow:var(--shadow-md);margin-bottom:28px;position:relative;overflow:hidden;}
    .logo-top{position:absolute;top:14px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.85);color:#fff;padding:6px 14px;border-radius:12px;font-weight:900;}
    body.dark .logo-top{background:#fff;color:var(--primary);}
    h1{font-size:2.4rem;font-weight:900;margin-top:26px;}
    .stats-bar{margin-top:14px;display:flex;gap:14px;justify-content:center;flex-wrap:wrap;}
    .stat{background:rgba(255,255,255,.07);padding:8px 14px;border-radius:12px;font-weight:700;}
    .sync-status{font-size:0.9rem;margin-top:8px;opacity:0.9;color:#fff;}
    .card{background:var(--card-light);border-radius:var(--radius-lg);box-shadow:var(--shadow-md);margin:18px auto;padding:0;overflow:hidden;max-width:1100px;transition:var(--transition);}
    body.dark .card{background:var(--card-dark);}
    .ch{background:linear-gradient(135deg,var(--primary),var(--primary-dark));color:#fff;padding:18px 26px;font-weight:800;display:flex;justify-content:space-between;align-items:center;}
    .cb{padding:26px;}
    .g{display:grid;grid-template-columns:1fr 1fr 100px 100px 130px 130px;gap:14px;align-items:end;}
    @media(max-width:980px){.g{grid-template-columns:1fr 1fr;}}
    @media(max-width:540px){.g{grid-template-columns:1fr;}}
    label{font-weight:700;margin-bottom:8px;display:block;}
    input{width:100%;padding:12px 14px;border-radius:12px;border:2px solid #e6eef8;background:#fff;color:#000;}
    body.dark input{border-color:rgba(255,255,255,0.08);background:transparent;color:inherit;}
    .btn{padding:12px 18px;border-radius:12px;font-weight:800;display:flex;align-items:center;justify-content:center;gap:8px;border:none;cursor:pointer;transition:var(--transition);box-shadow:0 4px 12px rgba(0,0,0,.25);font-size:0.95rem;}
    .ok{background:var(--success);color:#000;}
    .new{background:#ff6b35;color:#fff;}
    .pdf{background:var(--pdf-red);color:#fff;}
    .excel{background:var(--excel-green);color:#fff;}
    .sync-btn{background:var(--sync-purple);color:#fff;}
    .s{width:100%;padding:14px;border-radius:14px;border:2px solid #e6eef8;margin:18px 0;}
    table{width:100%;border-collapse:separate;border-spacing:0 12px;}
    th{background:var(--primary);color:white;padding:12px;border-radius:12px 12px 0 0;font-weight:800;}
    td{background:#fff;padding:12px;text-align:center;border-radius:12px;}
    body.dark td{background:rgba(255,255,255,0.05);}
    .fab{position:fixed;bottom:24px;right:24px;display:flex;flex-direction:column;gap:12px;z-index:9999;}
    .fab button{border-radius:50px;padding:16px;background:var(--primary);color:#fff;border:none;font-size:1.5rem;box-shadow:var(--shadow-md);width:56px;height:56px;}
    .fab button.pdf{background:var(--pdf-red);}
    .fab button.excel{background:var(--excel-green);}
    .fab button.sync-btn{background:var(--sync-purple);}
    .qb{font-size:1.8rem;cursor:pointer;background:none;border:none;}
    .qv{font-weight:900;font-size:1.4rem;}
    .qv.out{color:var(--danger);}
    .del-btn{background:var(--danger);color:#fff;padding:8px 12px;border-radius:8px;cursor:pointer;}
    .modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);align-items:center;justify-content:center;z-index:10000;}
    .modal-content{background:var(--card-light);border-radius:var(--radius-lg);padding:28px;width:90%;max-width:560px;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow-md);}
    body.dark .modal-content{background:var(--card-dark);}
    .close{float:right;font-size:2rem;cursor:pointer;}
    #toast{position:fixed;bottom:80px;left:50%;transform:translateX(-50%);z-index:10001;}
    .toast-msg{background:var(--success);color:#000;padding:12px 24px;border-radius:50px;margin:8px;box-shadow:var(--shadow-md);animation:toast 2.5s forwards;}
    @keyframes toast{0%{opacity:0;transform:translateY(20px)} 10%{opacity:1;transform:translateY(0)} 90%{opacity:1} 100%{opacity:0}}
    .full-select-modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.95);z-index:10001;align-items:center;justify-content:center;}
    .full-select{background:var(--card-light);width:94%;max-width:600px;max-height:92vh;border-radius:20px;overflow:hidden;box-shadow:var(--shadow-md);}
    body.dark .full-select{background:var(--card-dark);}
    .full-select-header{background:var(--primary);color:#fff;padding:22px;text-align:center;font-weight:900;font-size:1.6rem;}
    .full-select-list{max-height:75vh;overflow-y:auto;padding:16px;}
    .full-select-item{padding:22px 18px;border-bottom:1px solid #ddd;cursor:pointer;transition:var(--transition);font-size:1.35rem;font-weight:600;}
    body.dark .full-select-item{border-color:#444;}
    .full-select-item:hover{background:#e6f7ff;}
    body.dark .full-select-item:hover{background:#333;}
    .full-select-item strong{color:var(--primary);}
    .selected-display{margin-top:8px;font-weight:700;color:var(--primary);font-size:1.1rem;min-height:28px;padding:8px 12px;background:rgba(0,170,255,0.1);border-radius:12px;}
  </style>
</head>
<body>
  <div id="toast"></div>

  <header>
    <div class="logo-top">&lt; R.L ENERGIE &gt;</div>
    <h1>Inventaire</h1>
    <div class="sub">Stock & Suivi</div>
    <div class="week-moves" id="weekMoves">0 mouvements cette semaine</div>
    <div class="stats-bar">
      <div class="stat">Total: <span id="totalItems">0</span></div>
      <div class="stat">Entrées: <span id="entriesWeek">0</span></div>
      <div class="stat">Sorties: <span id="exitsWeek">0</span></div>
    </div>
    <div class="sync-status" id="syncStatus">Dernière sync : jamais</div>
  </header>

  <div class="card">
    <div class="ch">Ajouter un produit <button class="btn sync-btn" onclick="syncWithFirebase()">SYNC</button></div>
    <div class="cb">
      <div class="g">
        <div>
          <label>Catégorie</label>
          <button class="btn" style="width:100%;justify-content:space-between;font-size:1rem;padding:14px" onclick="openCatSelector()">Choisir catégorie <i class="fas fa-chevron-down"></i></button>
          <div class="selected-display" id="selectedCatDisplay"></div>
        </div>
        <div>
          <label>Référence</label>
          <button class="btn" style="width:100%;justify-content:space-between;font-size:1rem;padding:14px" onclick="openRefSelector()">Choisir référence <i class="fas fa-chevron-down"></i></button>
          <div class="selected-display" id="selectedRefDisplay"></div>
        </div>
        <div><label>Nom</label><input id="nom" readonly placeholder="Auto-rempli"></div>
        <div><label>Qté</label><input id="qte" type="number" value="1" min="1"></div>
        <div><button class="btn ok" onclick="add()">AJOUTER</button></div>
        <div><button class="btn new" onclick="openModal()">Gérer refs</button></div>
      </div>
      <input type="text" class="s" id="search" placeholder="Recherche instantanée..." oninput="show()">
    </div>
  </div>

  <div class="card">
    <div class="ch">Stock — <span id="tot">0</span> produits</div>
    <div class="cb">
      <div style="display:flex;gap:12px;margin-bottom:12px;">
        <select id="catFilter" onchange="show()"><option value="">Toutes catégories</option></select>
        <button class="btn" onclick="clearFilter()">Réinitialiser</button>
      </div>
      <table>
        <thead><tr><th>Réf</th><th>Produit</th><th>Stock</th><th>Catégorie</th><th>Actions</th></tr></thead>
        <tbody id="tab"></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <div class="ch">Derniers mouvements (10)</div>
    <div class="cb">
      <input type="text" class="s" id="searchSuivi" placeholder="Recherche mouvements..." oninput="updateLast5()">
      <table>
        <thead><tr><th>Date</th><th>Réf</th><th>Produit</th><th>Qté</th><th>Type</th></tr></thead>
        <tbody id="suiviTab"></tbody>
      </table>
      <div style="margin-top:12px;text-align:center;"><button class="btn" onclick="openFullSuivi()">Voir plus</button></div>
    </div>
  </div>

  <div class="fab">
    <button onclick="manageExport()" title="CSV"><i class="fas fa-table"></i></button>
    <button class="excel" onclick="exportExcel()" title="Excel"><i class="fas fa-file-excel"></i></button>
    <button class="pdf" onclick="generatePDF()" title="PDF"><i class="fas fa-file-pdf"></i></button>
    <button class="sync-btn" onclick="syncWithFirebase()" title="Sync"><i class="fas fa-cloud"></i></button>
    <button onclick="openSettings()" title="Paramètres"><i class="fas fa-cog"></i></button>
  </div>

  <!-- Selectors & Modals (identiques) -->
  <div class="full-select-modal" id="catSelector" onclick="this.style.display='none'">
    <div class="full-select" onclick="event.stopPropagation()">
      <div class="full-select-header">Choisir une catégorie</div>
      <div class="full-select-list" id="catList"></div>
    </div>
  </div>

  <div class="full-select-modal" id="refSelector" onclick="this.style.display='none'">
    <div class="full-select" onclick="event.stopPropagation()">
      <div class="full-select-header">Choisir une référence</div>
      <div class="full-select-list" id="refList"></div>
    </div>
  </div>

  <div class="modal" id="modal">
    <div class="modal-content">
      <span class="close" onclick="closeModal()">×</span>
      <h2>Gérer les références</h2>
      <hr>
      <h4>Ajouter une référence</h4>
      <table style="width:100%;margin:15px 0">
        <tr>
          <td><label>Catégorie</label><select id="newCat" style="width:100%"></select></td>
          <td><label>Nouvelle catégorie</label><input id="newCatInput" placeholder="Si vide = sélectionnée" style="width:100%"></td>
        </tr>
        <tr>
          <td><label>Référence</label><input id="newRef" placeholder="Ex: /PVJA-999" style="width:100%"></td>
          <td><label>Nom produit</label><input id="newNom" placeholder="Ex: JA Solar 999 Wc" style="width:100%"></td>
        </tr>
        <tr>
          <td colspan="2"><button class="btn ok" onclick="saveNewRef()" style="width:100%;margin-top:10px">Ajouter la référence</button></td>
        </tr>
      </table>
      <hr>
      <h4>Supprimer une référence</h4>
      <table style="width:100%;margin:15px 0">
        <tr>
          <td><label>Catégorie</label><select id="delCat" onchange="loadRefsToDelete()" style="width:100%"></select></td>
          <td><label>Référence à supprimer</label><select id="delRefSelect" style="width:100%"></select></td>
        </tr>
        <tr>
          <td colspan="2"><button class="btn pdf" onclick="deleteRef()" style="width:100%;margin-top:10px">Supprimer définitivement</button></td>
        </tr>
      </table>
    </div>
  </div>

  <div class="modal" id="qtyModal">
    <div class="modal-content" style="max-width:400px">
      <span class="close" onclick="closeQtyModal()">×</span>
      <h2 id="qtyTitle">Ajouter</h2>
      <p id="qtySubtitle"></p>
      <label>Quantité</label>
      <input id="qtyInput" type="number" min="1" style="font-size:2rem;text-align:center;margin:20px 0">
      <div style="display:flex;gap:12px;">
        <button class="btn ok" style="flex:1" onclick="confirmQty()">Valider</button>
        <button class="btn" style="flex:1;background:#888" onclick="closeQtyModal()">Annuler</button>
      </div>
    </div>
  </div>

  <div class="modal" id="fullSuiviModal">
    <div class="modal-content">
      <span class="close" onclick="document.getElementById('fullSuiviModal').style.display='none'">×</span>
      <h2>Historique complet</h2>
      <input type="text" class="s" id="searchFullSuivi" placeholder="Recherche..." oninput="updateFullSuivi()">
      <table><thead><tr><th>Date</th><th>Réf</th><th>Produit</th><th>Qté</th><th>Type</th></tr></thead><tbody id="fullSuiviTab"></tbody></table>
    </div>
  </div>

  <div class="modal" id="settingsModal">
    <div class="modal-content" style="max-width:400px">
      <span class="close" onclick="closeSettings()">×</span>
      <h2>Paramètres</h2>
      <label><input type="checkbox" id="soundToggle" onchange="soundEnabled=this.checked;localStorage.setItem('RL_SOUND',this.checked)"> Son activé</label><br><br>
      <label><input type="checkbox" id="darkToggle" onchange="document.body.classList.toggle('dark',this.checked);localStorage.setItem('RL_DARK',this.checked)"> Mode sombre</label><br><br>
      <button class="btn pdf" onclick="if(confirm('Tout effacer ?')){localStorage.clear();location.reload()}">Réinitialiser</button>
    </div>
  </div>

  <script>
    /********** CONFIG FIREBASE **********/
    // Remplace si nécessaire par ta config (celle-ci correspond à ton projet si tu l'as fourni)
    const firebaseConfig = {
      apiKey: "AIzaSyDKW6EIYv7LmGKHII3y6muiMxUKXSLxzu4",
      authDomain: "rl-energie-stock.firebaseapp.com",
      projectId: "rl-energie-stock",
      storageBucket: "rl-energie-stock.firebasestorage.app",
      messagingSenderId: "767757673730",
      appId: "1:767757673730:web:252f74ba07cb1880ae4e1b",
      measurementId: "G-4Y0XSBHR16"
    };
    // Init firebase compat
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /********** DONNÉES PAR DÉFAUT **********/
    const DEFAULT_BASE = {
      "PANNEAUX": ["/PVQCEL-G9-385KWC→QCells G9 385 Wc","/PVQCEL-G10-540→QCells G10 540 Wc","/PVTRINA400→Trina 400 Wc","/PVTRINA550→Trina Vertex S+ 550 Wc","/PVJA-545→JA Solar 545 Wc","/PVLONGI-550→Longi Hi-MO 6 550 Wc","/PVLONGI-660→Longi Hi-MO X6 660 Wc","/PVVICTRON-440→Victron 440 Wc","/PVDUAL-550→Dualsun Flash 550 Wc"],
      "COFFRET": ["/COF220A→Coffret 2x20A MC4","/COFDC20A→Coffret DC 20A","/COFDC40A→Coffret DC 40A"],
      "MONITORING": ["/CLE-WINET-S→Clé Wi-Fi SUNGROW","/CLE-WINET-L→Clé Wi-Fi SUNGROW LAN","/CLE-ETH-SG→Ethernet SUNGROW"],
      "DIVERS PETIT MATÉRIEL": ["/COLSONGR19→Colson grand 19mm","/COLSONPT12→Colson petit 12mm","/FIX-RALU→Fixation rail alu"],
      "CÂBLE SOLAIRE": ["/R2V4X10→Câble R2V 4x10mm²","/R2V4X16→Câble R2V 4x16mm²"],
      "ONDULEURS": ["/OND3-MO-HUA→Huawei SUN2000 3kW","/OND5-MO-HUA→Huawei SUN2000 5kW"],
      "DISJONCTEUR DIFFÉRENTIEL": ["/AGG160A→AGG 160A 4P","/AGG250A→AGG 250A 4P"]
    };

    /********** ÉTAT LOCAL **********/
    let BASE = JSON.parse(localStorage.getItem('RL_BASE_REFS') || 'null');
    if (!BASE || typeof BASE !== 'object' || Object.keys(BASE).length < Object.keys(DEFAULT_BASE).length) {
      BASE = JSON.parse(JSON.stringify(DEFAULT_BASE));
      localStorage.setItem('RL_BASE_REFS', JSON.stringify(BASE));
    }

    // stock est un objet local : clé = "cat|ref" -> {cat, ref, nom, q, updated, deleted}
    let stock = JSON.parse(localStorage.getItem('RLSTOCK') || '{}');
    let suivi = JSON.parse(localStorage.getItem('RL_SUIVI') || '[]');
    let soundEnabled = localStorage.getItem('RL_SOUND') !== 'false';
    let selectedCat = '';
    let selectedRef = '';
    let selectedNom = '';

    /********** UTILITAIRES **********/
    function toast(msg, ms = 2500) {
      const t = document.getElementById('toast');
      const d = document.createElement('div');
      d.className = 'toast-msg';
      d.innerHTML = `<i class="fas fa-check-circle"></i> ${msg}`;
      t.appendChild(d);
      setTimeout(() => d.remove(), ms);
      playSound();
    }
    function playSound() {
      if (soundEnabled) new Audio('data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQAAAAA=').play().catch(()=>{});
    }

    // Convertir stock objet -> tableau pour Firestore (évite problèmes de clé)
    function stockToArray(obj) {
      return Object.keys(obj).map(k => {
        const it = obj[k];
        return Object.assign({ _key: k }, it);
      });
    }
    // Rebuild local stock depuis tableau cloud (fusion en respectant updated)
    function mergeStockFromArray(arr) {
      if (!Array.isArray(arr)) return;
      arr.forEach(it => {
        const k = it._key || (it.cat && it.ref ? (it.cat + '|' + it.ref) : null);
        if (!k) return;
        const existing = stock[k];
        // si pas existant -> ajouter
        if (!existing) {
          stock[k] = it;
        } else {
          // garder la version la plus récente selon updated
          const existingUpdated = existing.updated || 0;
          const incomingUpdated = it.updated || 0;
          if (incomingUpdated >= existingUpdated) {
            stock[k] = it;
          }
        }
      });
    }
    // Nettoyage UI : supprimer tombstones trop anciens (optionnel) - pas exécuté maintenant

    /********** FIRESTORE SYNC **********/
    // Document unique pour stock/suivi/BASE
    const APP_DOC = db.collection('rl_app').doc('data');

    async function syncWithFirebase() {
      toast("Synchronisation...");
      try {
        const snap = await APP_DOC.get();
        if (snap.exists) {
          const d = snap.data() || {};
          // Merge stock: cloud -> local
          if (Array.isArray(d.stock)) {
            mergeStockFromArray(d.stock);
          }
          // Merge suivi (simple merge by timestamp: add cloud entries not present)
          if (Array.isArray(d.suivi)) {
            // keep unique by JSON string/time
            const existingSet = new Set(suivi.map(s => JSON.stringify(s)));
            d.suivi.forEach(s => {
              const key = JSON.stringify(s);
              if (!existingSet.has(key)) {
                suivi.push(s);
              }
            });
          }
          // Merge BASE if provided
          if (d.BASE) BASE = d.BASE;
          // Persist local and show
          saveLocalOnly(); // save local storage
          show(); updateLast5(); updateStats();
          document.getElementById("syncStatus").innerHTML = `<i class="fas fa-check"></i> Sync OK • ${new Date().toLocaleString()}`;
          toast("Synchronisé !");
        } else {
          // Aucun doc -> créer à partir du local
          await saveAll(); // créer doc cloud
          document.getElementById("syncStatus").innerHTML = `<i class="fas fa-check"></i> Sync OK (initial) • ${new Date().toLocaleString()}`;
          toast("Initial cloud créé !");
        }
      } catch (err) {
        console.error("sync error", err);
        toast("Erreur connexion");
      }
    }

    // Sauvegarde complète : localStorage + Firestore (utiliser quand tu veux pousser)
    async function saveAll() {
      saveLocalOnly();
      try {
        const payload = {
          stock: stockToArray(stock),
          suivi: suivi.slice(-2000), // limite la taille
          BASE: BASE,
          updatedAt: Date.now()
        };
        await APP_DOC.set(payload, { merge: true });
      } catch (err) {
        console.error("Firebase write error", err);
        toast("Firebase write error");
      }
    }
    // Sauvegarde locale seulement
    function saveLocalOnly() {
      localStorage.setItem('RLSTOCK', JSON.stringify(stock));
      localStorage.setItem('RL_SUIVI', JSON.stringify(suivi));
      localStorage.setItem('RL_BASE_REFS', JSON.stringify(BASE));
    }

    /********** LOGIQUE APPLI (ajout, retrait, delete...) **********/
    function openCatSelector() {
      const list = document.getElementById('catList');
      list.innerHTML = '';
      Object.keys(BASE).sort().forEach(cat => {
        const div = document.createElement('div');
        div.className = 'full-select-item';
        div.textContent = cat;
        div.onclick = () => {
          selectedCat = cat;
          document.getElementById('selectedCatDisplay').textContent = cat;
          selectedRef = '';
          selectedNom = '';
          document.getElementById('selectedRefDisplay').textContent = '';
          document.getElementById('nom').value = '';
          document.getElementById('catSelector').style.display = 'none';
        };
        list.appendChild(div);
      });
      document.getElementById('catSelector').style.display = 'flex';
    }

    function openRefSelector() {
      if (!selectedCat) return toast("Choisis d'abord une catégorie");
      const list = document.getElementById('refList');
      list.innerHTML = '';
      (BASE[selectedCat] || []).forEach(item => {
        const parts = item.split('→');
        const ref = parts[0].trim();
        const nom = (parts[1] || '').trim();
        const div = document.createElement('div');
        div.className = 'full-select-item';
        div.innerHTML = `<strong>${ref}</strong><br><span style="font-size:1.1rem;color:#666">${nom}</span>`;
        div.onclick = () => {
          selectedRef = ref;
          selectedNom = nom;
          document.getElementById('selectedRefDisplay').innerHTML = `<strong>${ref}</strong> — ${nom}`;
          document.getElementById('nom').value = nom;
          document.getElementById('refSelector').style.display = 'none';
        };
        list.appendChild(div);
      });
      document.getElementById('refSelector').style.display = 'flex';
    }

    function add() {
      playSound();
      if (!selectedCat || !selectedRef) return toast("Choisis catégorie + référence");
      const qte = parseInt(document.getElementById('qte').value) || 0;
      if (qte <= 0) return toast("Quantité invalide");
      const key = selectedCat + '|' + selectedRef;
      const now = Date.now();
      if (!stock[key]) stock[key] = { cat: selectedCat, ref: selectedRef, nom: selectedNom, q: 0, updated: now, deleted: false };
      stock[key].q = (stock[key].q || 0) + qte;
      stock[key].updated = now;
      stock[key].deleted = false;
      suivi.push({ date: new Date().toLocaleString(), ref: selectedRef, nom: selectedNom, qte, type: '+' , ts: now});
      saveAll();
      show(); updateLast5(); updateStats();
      toast(`+${qte} ${selectedNom}`);
      document.getElementById('qte').value = 1;
    }

    function openQtyModal(key, add) {
      window.currentQtyKey = key;
      window.isAdding = add;
      document.getElementById('qtyModal').style.display = 'flex';
      document.getElementById('qtyTitle').textContent = add ? 'Ajouter' : 'Retirer';
      document.getElementById('qtySubtitle').textContent = stock[key] ? `${stock[key].nom} — ${stock[key].q} en stock` : '';
      document.getElementById('qtyInput').focus();
    }

    function confirmQty() {
      const q = parseInt(document.getElementById('qtyInput').value);
      if (!q || q <= 0) return toast('Quantité invalide');
      const key = window.currentQtyKey;
      const now = Date.now();
      if (!window.isAdding && (stock[key].q || 0) < q) return toast('Pas assez en stock');
      if (window.isAdding) {
        stock[key].q = (stock[key].q || 0) + q;
        stock[key].updated = now;
        stock[key].deleted = false;
        suivi.push({ date: new Date().toLocaleString(), ref: stock[key].ref, nom: stock[key].nom, qte: q, type: '+' , ts: now});
        toast(`+${q} ${stock[key].nom}`);
      } else {
        stock[key].q = (stock[key].q || 0) - q;
        stock[key].updated = now;
        suivi.push({ date: new Date().toLocaleString(), ref: stock[key].ref, nom: stock[key].nom, qte: q, type: '-' , ts: now});
        toast(`-${q} ${stock[key].nom}`);
        if (stock[key].q <= 0) {
          // tombstone instead of deletion (so other clients know it was deleted)
          stock[key].q = 0;
          stock[key].deleted = true;
          stock[key].updated = now;
        }
      }
      saveAll(); show(); updateLast5(); updateStats();
      closeQtyModal();
    }

    function closeQtyModal() {
      document.getElementById('qtyModal').style.display = 'none';
      document.getElementById('qtyInput').value = '';
    }

    function deleteFull(key) {
      if (!confirm('Supprimer définitivement cet article ?')) return;
      const item = stock[key];
      const now = Date.now();
      // Set tombstone deleted = true
      stock[key] = Object.assign({}, item, { q: 0, deleted: true, updated: now });
      suivi.push({ date: new Date().toLocaleString(), ref: item.ref, nom: item.nom, qte: item.q, type: 'Supprimé', ts: now});
      saveAll(); show(); updateLast5(); updateStats();
      toast(`${item.nom} supprimé`);
    }

    function show() {
      const search = (document.getElementById('search').value || '').toLowerCase();
      const filter = document.getElementById('catFilter').value;
      const tab = document.getElementById('tab'); tab.innerHTML = '';
      let tot = 0;
      Object.keys(stock).sort((a,b) => (stock[a].nom||'').localeCompare(stock[b].nom||'')).forEach(k => {
        const i = stock[k];
        if (!i) return;
        if (i.deleted) return; // don't show deleted items
        if (filter && i.cat !== filter) return;
        if (search && !i.nom.toLowerCase().includes(search) && !i.ref.toLowerCase().includes(search)) return;
        tot += i.q || 0;
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td style="font-family:monospace">${i.ref}</td>
          <td style="text-align:left;padding-left:12px">${i.nom}</td>
          <td>
            <button class="qb" onclick="openQtyModal('${k}', false)">−</button>
            <span class="${(i.q||0) <= 0 ? 'qv out' : 'qv'}">${i.q||0}</span>
            <button class="qb" onclick="openQtyModal('${k}', true)">+</button>
          </td>
          <td>${i.cat}</td>
          <td><button class="del-btn" onclick="deleteFull('${k}')"><i class="fas fa-trash"></i></button></td>
        `;
        tab.appendChild(tr);
      });
      document.getElementById('tot').textContent = tot;
    }

    function updateLast5() {
      const search = (document.getElementById('searchSuivi').value || '').toLowerCase();
      const tab = document.getElementById('suiviTab'); tab.innerHTML = '';
      const recent = suivi.slice(-10).reverse().filter(m => !search || (m.nom||'').toLowerCase().includes(search) || (m.ref||'').toLowerCase().includes(search));
      recent.forEach(m => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${m.date}</td><td>${m.ref}</td><td style="text-align:left;padding-left:12px">${m.nom}</td><td>${m.type}${m.qte}</td><td>${m.type==='+'?'Entrée':(m.type==='-'?'Sortie':'Autre')}</td>`;
        tab.appendChild(tr);
      });
    }

    function openFullSuivi() {
      document.getElementById('fullSuiviModal').style.display = 'flex';
      updateFullSuivi();
    }

    function updateFullSuivi() {
      const search = (document.getElementById('searchFullSuivi').value || '').toLowerCase();
      const tab = document.getElementById('fullSuiviTab'); tab.innerHTML = '';
      suivi.slice().reverse().filter(m => !search || (m.nom||'').toLowerCase().includes(search) || (m.ref||'').toLowerCase().includes(search)).forEach(m => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${m.date}</td><td>${m.ref}</td><td style="text-align:left;padding-left:12px">${m.nom}</td><td>${m.type}${m.qte}</td><td>${m.type==='+'?'Entrée':(m.type==='-'?'Sortie':'Autre')}</td>`;
        tab.appendChild(tr);
      });
    }

    function updateStats() {
      const total = Object.values(stock).reduce((a,b)=>a+(b.q||0),0);
      document.getElementById('totalItems').textContent = total;
      const now = new Date();
      const weekStart = new Date(now);
      weekStart.setDate(now.getDate() - now.getDay());
      weekStart.setHours(0,0,0,0);
      const weekMoves = suivi.filter(m => new Date(m.date) >= weekStart);
      const entries = weekMoves.filter(m => m.type === '+').reduce((a,b)=>a+b.qte,0);
      const exits = weekMoves.filter(m => m.type === '-').reduce((a,b)=>a+b.qte,0);
      document.getElementById('weekMoves').textContent = `${weekMoves.length} mouvements cette semaine`;
      document.getElementById('entriesWeek').textContent = entries;
      document.getElementById('exitsWeek').textContent = exits;
    }

    /********** EXPORT / PDF **********/
    function manageExport() {
      const rows = [['RÉF','PRODUIT','QTÉ','CATÉGORIE']];
      Object.keys(stock).forEach(k => {
        const s = stock[k];
        if (s && !s.deleted) rows.push([s.ref, s.nom, s.q, s.cat]);
      });
      const csv = "\uFEFF" + rows.map(r => r.join(';')).join('\n');
      const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `RL_STOCK_${new Date().toISOString().slice(0,10)}.csv`;
      a.click();
      URL.revokeObjectURL(url);
      toast('CSV exporté !');
    }

    function exportExcel() {
      const rows = Object.keys(stock).filter(k => !stock[k].deleted).map(k => ({Réf: stock[k].ref, Produit: stock[k].nom, Qté: stock[k].q, Catégorie: stock[k].cat}));
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(rows);
      XLSX.utils.book_append_sheet(wb, ws, 'Stock');
      XLSX.writeFile(wb, `RL_STOCK_${new Date().toISOString().slice(0,10)}.xlsx`);
      toast('Excel exporté !');
    }

    function generatePDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l','mm','a4');
      doc.setFontSize(18);
      doc.text('R.L ENERGIE - STOCK', 148, 16, null, null, 'center');
      const data = Object.keys(stock).filter(k => !stock[k].deleted).map(k => [stock[k].ref, stock[k].nom, stock[k].q, stock[k].cat]);
      doc.autoTable({ head: [['RÉF','PRODUIT','QTÉ','CATÉGORIE']], body: data, startY: 30, styles: { fontSize: 9 } });
      doc.save('RL_STOCK.pdf');
      toast('PDF généré !');
    }

    /********** REFS management **********/
    function saveNewRef() {
      let cat = document.getElementById('newCat').value;
      const newCatInput = document.getElementById('newCatInput').value.trim();
      if (newCatInput) cat = newCatInput;
      const ref = document.getElementById('newRef').value.trim();
      const nom = document.getElementById('newNom').value.trim();
      if (!cat || !ref || !nom) return toast('Remplis tout !');
      if (!BASE[cat]) BASE[cat] = [];
      if (BASE[cat].some(x => x.startsWith(ref))) return toast('Référence existe déjà');
      BASE[cat].push(ref + '→' + nom);
      saveAll();
      toast('Référence ajoutée !');
      document.getElementById('newRef').value = '';
      document.getElementById('newNom').value = '';
      document.getElementById('newCatInput').value = '';
      closeModal();
    }

    function loadRefsToDelete() {
      const cat = document.getElementById('delCat').value;
      const sel = document.getElementById('delRefSelect');
      sel.innerHTML = '<option value="">Référence</option>';
      if (!cat || !BASE[cat]) return;
      BASE[cat].forEach(s => {
        const [r,n] = s.split('→');
        const opt = document.createElement('option');
        opt.value = (r||'').trim();
        opt.textContent = `${(r||'').trim()} — ${n||''}`;
        sel.appendChild(opt);
      });
    }

    function deleteRef() {
      const cat = document.getElementById('delCat').value;
      const ref = document.getElementById('delRefSelect').value;
      if (!cat || !ref) return toast('Sélectionne tout');
      if (!confirm(`Supprimer ${ref} de ${cat} ?`)) return;
      BASE[cat] = BASE[cat].filter(x => !x.startsWith(ref));
      if (BASE[cat].length === 0) delete BASE[cat];
      saveAll();
      toast('Référence supprimée');
      closeModal();
    }

    function openModal() { document.getElementById('modal').style.display = 'flex'; populateCatSelects(); loadRefsToDelete(); }
    function closeModal() { document.getElementById('modal').style.display = 'none'; }
    function openSettings() { document.getElementById('settingsModal').style.display = 'flex'; document.getElementById('soundToggle').checked = soundEnabled; document.getElementById('darkToggle').checked = document.body.classList.contains('dark'); }
    function closeSettings() { document.getElementById('settingsModal').style.display = 'none'; }
    function clearFilter() { document.getElementById('catFilter').value = ''; show(); }

    function populateCatSelects() {
      const cats = Object.keys(BASE).sort();
      ['catFilter','newCat','delCat'].forEach(id => {
        const sel = document.getElementById(id);
        if (sel) {
          sel.innerHTML = '<option value="">Choisir...</option>';
          cats.forEach(c => {
            const o = document.createElement('option');
            o.value = c; o.textContent = c;
            sel.appendChild(o);
          });
        }
      });
    }

    /********** INIT **********/
    window.addEventListener('load', () => {
      document.body.classList.toggle('dark', localStorage.getItem('RL_DARK') === 'true');
      populateCatSelects();
      show();
      updateLast5();
      updateStats();
      toast('R.L ENERGIE chargé – TOUT marche !');
    });
  </script>
</body>
</html>





